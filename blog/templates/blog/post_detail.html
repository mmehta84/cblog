{% extends 'blog/base.html' %}
{% load blog_tags %}

{% block title %}{{ post.title }} — AI-QA Blog{% endblock %}
{% block meta_description %}{{ post.excerpt|default:post.body|strip_tags|truncatechars:160 }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-10 sm:px-6 lg:px-8">
    <div class="flex flex-col lg:flex-row gap-10">

        <!-- ARTICLE -->
        <article class="flex-1 min-w-0">

            <!-- Breadcrumb -->
            <nav class="flex items-center gap-2 text-sm text-ink-faint mb-6 flex-wrap">
                <a href="{% url 'blog:post_list' %}"
                   class="hover:text-brand active:opacity-70 focus-visible:outline-none focus-visible:underline"
                   style="transition: color 0.15s;">Home</a>
                <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
                {% if post.category %}
                <a href="{{ post.category.get_absolute_url }}"
                   class="hover:text-brand active:opacity-70 focus-visible:outline-none focus-visible:underline"
                   style="transition: color 0.15s;">{{ post.category.name }}</a>
                <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
                {% endif %}
                <span class="text-ink-muted font-medium truncate">{{ post.title|truncatechars:60 }}</span>
            </nav>

            <!-- Category Badge -->
            {% if post.category %}
            <a href="{{ post.category.get_absolute_url }}"
               class="tag-pill inline-block mb-5 px-3 py-1 text-xs font-bold uppercase tracking-widest rounded-full hover:opacity-90 active:scale-95 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent/40"
               style="color: #9E4A13; background: #F5E2D0;">
                {{ post.category.name }}
            </a>
            {% endif %}

            <!-- Title -->
            <h1 class="font-display font-bold text-ink leading-tight mb-5"
                style="font-size: clamp(1.9rem, 4vw, 3rem); letter-spacing: -0.02em;">
                {{ post.title }}
            </h1>

            <!-- Meta Row -->
            <div class="flex flex-wrap items-center gap-x-4 gap-y-2 text-sm text-ink-muted mb-8 pb-6"
                 style="border-bottom: 1px solid rgba(13,59,56,0.10);">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center text-cream text-xs font-bold flex-shrink-0"
                         style="background: #0D3B38;">
                        {{ post.author.first_name|first|upper|default:post.author.username|first|upper }}
                    </div>
                    <span class="font-semibold text-ink">{{ post.author.get_full_name|default:post.author.username }}</span>
                </div>
                <span class="text-ink-faint hidden sm:block">·</span>
                <span>{{ post.created_at|date:"F j, Y" }}</span>
                <span class="text-ink-faint hidden sm:block">·</span>
                <span class="flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    {{ post.reading_time }} min read
                </span>
                <span class="text-ink-faint hidden sm:block">·</span>
                <span class="flex items-center gap-1">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                        <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                    </svg>
                    {{ post.views_count }} views
                </span>

                {% if user == post.author or user.is_staff %}
                <div class="ml-auto flex gap-2">
                    <a href="{% url 'blog:post_update' post.slug %}"
                       class="flex items-center gap-1 px-3 py-1.5 text-xs font-semibold rounded-full hover:opacity-90 active:scale-[0.96] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-amber-400/40"
                       style="color: #856404; background: #FFF3CD; border: 1px solid #FEDD78; transition: opacity 0.15s, transform 0.15s;">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                        </svg>
                        Edit
                    </a>
                    <a href="{% url 'blog:post_delete' post.slug %}"
                       class="flex items-center gap-1 px-3 py-1.5 text-xs font-semibold rounded-full hover:opacity-90 active:scale-[0.96] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-red-400/40"
                       style="color: #991B1B; background: #FEF2F2; border: 1px solid #FECACA; transition: opacity 0.15s, transform 0.15s;">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                        Delete
                    </a>
                </div>
                {% endif %}
            </div>

            <!-- Featured Image -->
            {% if post.featured_image %}
            <div class="rounded-2xl overflow-hidden mb-8 relative"
                 style="box-shadow: var(--shadow-md);">
                <img src="{{ post.featured_image.url }}" alt="{{ post.title }}"
                     class="w-full object-cover" style="max-height: 500px;" />
                <div class="absolute inset-0 pointer-events-none"
                     style="background: linear-gradient(to top, rgba(0,0,0,0.45) 0%, transparent 55%);"></div>
                <div class="absolute inset-0 pointer-events-none mix-blend-multiply"
                     style="background: rgba(13,59,56,0.18);"></div>
            </div>
            {% endif %}

            <!-- Post Body -->
            <div class="ck-content">
                {{ post.body|safe }}
            </div>

            <!-- Tags -->
            {% if post.tags.exists %}
            <div class="flex flex-wrap items-center gap-2 mt-10 pt-6"
                 style="border-top: 1px solid rgba(13,59,56,0.10);">
                <span class="text-sm font-bold text-ink-faint uppercase tracking-wide">Tags:</span>
                {% for tag in post.tags.all %}
                <a href="{{ tag.get_absolute_url }}"
                   class="tag-pill text-sm font-medium px-3 py-1 rounded-full focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand/40"
                   style="color: #0D3B38; background: #EAF3F2; border: 1px solid #C8DEDC;">
                    #{{ tag.name }}
                </a>
                {% endfor %}
            </div>
            {% endif %}

            {% if post.updated_at != post.created_at %}
            <p class="text-xs text-ink-faint mt-4">Last updated: {{ post.updated_at|date:"F j, Y g:i A" }}</p>
            {% endif %}

            <!-- Related Posts -->
            {% if related_posts %}
            <div class="mt-14">
                <h3 class="font-display text-xl font-bold text-ink mb-6 flex items-center gap-3"
                    style="letter-spacing: -0.01em;">
                    <span class="w-1 h-6 rounded-full block" style="background: #C8601A;"></span>
                    You might also like
                </h3>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    {% for related in related_posts %}
                    <a href="{{ related.get_absolute_url }}"
                       class="post-card block bg-cream rounded-xl overflow-hidden group"
                       style="border: 1px solid rgba(13,59,56,0.10); box-shadow: var(--shadow-sm);">
                        <div class="relative overflow-hidden" style="aspect-ratio: 16/9;">
                            {% if related.featured_image %}
                            <img src="{{ related.featured_image.url }}" alt="{{ related.title }}"
                                 class="w-full h-full object-cover"
                                 style="transition: transform 0.4s ease;" />
                            <div class="absolute inset-0 pointer-events-none"
                                 style="background: linear-gradient(to top, rgba(0,0,0,0.50) 0%, transparent 60%);"></div>
                            <div class="absolute inset-0 pointer-events-none mix-blend-multiply"
                                 style="background: rgba(13,59,56,0.18);"></div>
                            {% else %}
                            <div class="w-full h-full flex items-center justify-center"
                                 style="background: linear-gradient(135deg, #0D3B38, #1A5C57);">
                                <span class="font-display font-bold select-none"
                                      style="font-size: 2rem; color: rgba(255,255,255,0.18);">{{ related.title|first|upper }}</span>
                            </div>
                            {% endif %}
                        </div>
                        <div class="p-4">
                            <h4 class="font-display text-sm font-bold text-ink group-hover:text-brand leading-snug line-clamp-2"
                                style="letter-spacing: -0.01em; transition: color 0.15s;">{{ related.title }}</h4>
                            <p class="text-xs text-ink-faint mt-1">{{ related.created_at|date:"M j, Y" }}</p>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

        </article>

        <!-- STICKY SIDEBAR -->
        <aside class="lg:w-72 space-y-4 flex-shrink-0 lg:sticky lg:top-20 lg:self-start">

            <div class="bg-cream rounded-2xl overflow-hidden"
                 style="border: 1px solid rgba(13,59,56,0.10); box-shadow: var(--shadow-sm);">
                <div class="px-5 py-4" style="border-bottom: 1px solid rgba(13,59,56,0.08);">
                    <h3 class="font-semibold text-ink text-sm">Categories</h3>
                </div>
                <ul class="p-3 space-y-0.5">
                    {% for cat in categories %}
                    <li>
                        <a href="{{ cat.get_absolute_url }}"
                           class="flex items-center justify-between px-3 py-2 rounded-xl group hover:bg-brand-faint active:opacity-80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand/40"
                           style="transition: background-color 0.15s;">
                            <span class="text-sm text-ink-muted font-medium group-hover:text-brand"
                                  style="transition: color 0.15s;">{{ cat.name }}</span>
                            <span class="text-xs px-2 py-0.5 rounded-full font-semibold"
                                  style="background: rgba(13,59,56,0.07); color: #6B6458;">{{ cat.post_count }}</span>
                        </a>
                    </li>
                    {% empty %}
                    <li class="px-3 py-3 text-sm text-ink-faint">No categories.</li>
                    {% endfor %}
                </ul>
            </div>

            <div class="bg-cream rounded-2xl p-5"
                 style="border: 1px solid rgba(13,59,56,0.10); box-shadow: var(--shadow-sm);">
                <h3 class="font-semibold text-ink text-sm mb-3">
                    <span class="text-accent font-bold">#</span> Tags
                </h3>
                <div class="flex flex-wrap gap-2">
                    {% for tag in tags %}
                    <a href="{{ tag.get_absolute_url }}"
                       class="tag-pill text-xs font-semibold px-2.5 py-1 rounded-full focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand/40"
                       style="color: #0D3B38; background: #EAF3F2; border: 1px solid #C8DEDC;"
                       onmouseover="this.style.background='#0D3B38';this.style.color='#FFFCF5';this.style.borderColor='#0D3B38';"
                       onmouseout="this.style.background='#EAF3F2';this.style.color='#0D3B38';this.style.borderColor='#C8DEDC';">
                        #{{ tag.name }}
                    </a>
                    {% empty %}
                    <p class="text-sm text-ink-faint">No tags.</p>
                    {% endfor %}
                </div>
            </div>

            <div class="bg-cream rounded-2xl overflow-hidden"
                 style="border: 1px solid rgba(13,59,56,0.10); box-shadow: var(--shadow-sm);">
                <div class="px-5 py-4" style="border-bottom: 1px solid rgba(13,59,56,0.08);">
                    <h3 class="font-semibold text-ink text-sm">Recent Posts</h3>
                </div>
                <ul class="p-4 space-y-4">
                    {% for recent in recent_posts %}
                    <li>
                        <a href="{{ recent.get_absolute_url }}"
                           class="text-sm font-semibold text-ink hover:text-brand active:opacity-80 focus-visible:outline-none focus-visible:underline leading-snug line-clamp-2 block"
                           style="transition: color 0.15s;">{{ recent.title }}</a>
                        <span class="text-xs text-ink-faint">{{ recent.created_at|date:"M j, Y" }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </aside>

    </div>
</div>
{% endblock %}
